# app/external/transcript.py
from youtube_transcript_api import YouTubeTranscriptApi
from youtube_transcript_api._errors import TranscriptsDisabled, NoTranscriptFound
import os

def get_transcript_text(video_id: str) -> str:
    cookies_path = "/app/cookies.txt"
    cookies = cookies_path if os.path.exists(cookies_path) else None

    try:
        transcript_list = YouTubeTranscriptApi.list_transcripts(
            video_id,
            cookies=cookies
        )
        auto_transcript = transcript_list.find_generated_transcript(['ru', 'en'])
        data = auto_transcript.fetch()
        return " ".join([item['text'] for item in data])
    except (TranscriptsDisabled, NoTranscriptFound):
        raise ValueError(f"No autogenerated transcript for {video_id}")
    except Exception as e:
        raise ValueError(f"Network error for {video_id}: {e}")